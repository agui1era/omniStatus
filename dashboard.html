<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Events Dashboard - omniStatus</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #0b1222;
      --muted: #94a3b8;
      --accent: #22c55e;
      --accent-2: #f59e0b;
      --text: #e2e8f0;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(34, 197, 94, 0.08), transparent 30%),
                  radial-gradient(circle at 80% 0%, rgba(245, 158, 11, 0.08), transparent 30%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 28px;
    }
    h1 { margin: 0 0 12px; font-size: 28px; letter-spacing: -0.02em; }
    p.lead { margin: 0 0 24px; color: var(--muted); }
    .layout { max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; gap: 16px; }
    .cards { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .card {
      background: linear-gradient(145deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.25);
    }
    .card h3 { margin: 0 0 8px; font-size: 14px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
    .metric { font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.02); color: var(--muted); }
    .muted { color: var(--muted); font-size: 13px; }
    .filters { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1426;
      color: var(--text);
      font-size: 14px;
    }
    input:focus, select:focus { outline: 2px solid rgba(34, 197, 94, 0.4); }
    .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button {
      border: 1px solid var(--border);
      background: #111827;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    button:hover { transform: translateY(-1px); border-color: #1f9d5a; }
    button.primary { background: linear-gradient(135deg, #22c55e, #16a34a); border: none; }
    button.ghost { background: transparent; }
    button.active { border-color: #22c55e; color: #22c55e; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); text-align: left; font-size: 13px; }
    th { color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; }
    tbody tr:hover { background: rgba(255,255,255,0.02); }
    .tag { padding: 4px 8px; background: rgba(34, 197, 94, 0.15); color: #bbf7d0; border-radius: 999px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
    .tag.warn { background: rgba(245, 158, 11, 0.15); color: #fcd34d; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); display: inline-block; }
    .status-dot.warn { background: var(--accent-2); }
    .status-dot.err { background: #ef4444; }
    .table-wrapper { overflow: auto; border: 1px solid var(--border); border-radius: 14px; background: #0b1222; }
    .hint { margin-top: 6px; font-size: 12px; color: var(--muted); }
    .search-inline { flex: 1; min-width: 200px; }
    .error { color: #fca5a5; margin-top: 6px; font-size: 13px; }
    @media (max-width: 720px) {
      body { padding: 18px; }
      .filter-bar { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <h1>Events Dashboard</h1>
    <p class="lead">Quick queries with filters by date, time, and text.</p>

    <div class="card">
      <div class="filter-bar">
        <div style="flex: 1; min-width: 240px;">
          <label>API Server</label>
          <input id="baseUrl" value="http://localhost:8001" placeholder="http://localhost:8001">
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label>API Key (X-API-Key)</label>
          <input id="apiKey" value="" placeholder="optional">
          <div class="hint">Use if API_TOKEN is set on the server.</div>
        </div>
        <button class="primary" id="refreshBtn">Refresh</button>
        <button class="ghost" id="autoToggle">Auto (15s)</button>
        <div style="min-width: 160px;">
          <label>View</label>
          <select id="viewMode">
            <option value="table">Table</option>
            <option value="summary3h">3h summary</option>
            <option value="summaryDay">Daily summary</option>
          </select>
        </div>
      </div>
      <div class="filters" style="margin-top: 14px;">
        <div>
          <label>Start (ISO)</label>
          <input id="start" type="datetime-local">
          <div class="hint">Used if no quick window is chosen.</div>
        </div>
        <div>
          <label>End (ISO)</label>
          <input id="end" type="datetime-local">
        </div>
        <div>
          <label>Text contains</label>
          <input id="search" placeholder="login, error, access...">
        </div>
        <div>
          <label>Limit</label>
          <input id="limit" type="number" min="1" max="1000" value="200">
        </div>
      </div>
      <div id="feedback" class="error"></div>
    </div>

    <div class="grid cards" style="margin: 16px 0;">
      <div class="card">
        <h3>Total</h3>
        <div class="metric"><span class="status-dot" id="statusDot"></span><span id="total">—</span></div>
        <div class="muted" id="timeRange">No data</div>
      </div>
      <div class="card">
        <h3>Avg risk</h3>
        <div class="metric"><span id="avgScore">—</span></div>
        <div class="muted" id="scoreDetail">Uses score/value when present</div>
      </div>
    </div>

    <div class="card">
      <div class="filter-bar" style="margin-bottom: 12px;">
        <div class="pill" id="countLabel">0 events</div>
        <div class="pill" id="serverLabel">No connection</div>
        <button class="ghost" id="copyJson">Copy JSON</button>
        <button class="ghost" id="clearFilters">Clear filters</button>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Source/Login</th>
              <th>Text</th>
              <th>Score/Value</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="4" class="muted">Initial load...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const feedback = document.getElementById("feedback");
    const baseUrlInput = document.getElementById("baseUrl");
    const apiKeyInput = document.getElementById("apiKey");
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const searchInput = document.getElementById("search");
    const limitInput = document.getElementById("limit");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoToggle = document.getElementById("autoToggle");
    const tableBody = document.getElementById("tableBody");
    const tableHead = document.querySelector("table thead tr");
    const viewModeSelect = document.getElementById("viewMode");
    const countLabel = document.getElementById("countLabel");
    const serverLabel = document.getElementById("serverLabel");
    const statusDot = document.getElementById("statusDot");
    const avgScore = document.getElementById("avgScore");
    const scoreDetail = document.getElementById("scoreDetail");
    const timeRange = document.getElementById("timeRange");
    const copyJson = document.getElementById("copyJson");
    const clearFiltersBtn = document.getElementById("clearFilters");

    let autoInterval = null;
    let latestPayload = [];
    let viewMode = "table"; // table | summary3h | summaryDay

    refreshBtn.addEventListener("click", loadEvents);

    autoToggle.addEventListener("click", () => {
      if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
        autoToggle.classList.remove("active");
        autoToggle.textContent = "Auto (15s)";
      } else {
        autoInterval = setInterval(loadEvents, 15000);
        autoToggle.classList.add("active");
        autoToggle.textContent = "Auto ON";
      }
    });

    copyJson.addEventListener("click", () => {
      navigator.clipboard.writeText(JSON.stringify(latestPayload, null, 2))
        .then(() => notify("JSON copied", false))
        .catch(() => notify("Copy failed", true));
    });

    searchInput.addEventListener("input", () => renderView(latestPayload));
    viewModeSelect.addEventListener("change", () => {
      viewMode = viewModeSelect.value;
      loadEvents();
    });

    clearFiltersBtn.addEventListener("click", () => {
      startInput.value = "";
      endInput.value = "";
      searchInput.value = "";
      limitInput.value = 200;
      loadEvents();
    });

    function buildParams() {
      const params = new URLSearchParams();
      const limit = Number(limitInput.value) || 200;
      params.set("limit", Math.min(Math.max(limit, 1), 1000));

      const baseStart = startInput.value ? new Date(startInput.value).toISOString() : "";
      const baseEnd = endInput.value ? new Date(endInput.value).toISOString() : "";

      if (baseStart) params.set("start", baseStart);
      if (baseEnd) params.set("end", baseEnd);

      const text = searchInput.value.trim();
      if (text) params.set("text", text);

      return params;
    }

    async function loadEvents() {
      feedback.textContent = "";
      statusDot.className = "status-dot";
      const base = (baseUrlInput.value || "http://localhost:8001").replace(/\/$/, "");
      serverLabel.textContent = "Consultando...";
      feedback.textContent = "";

      try {
        let url = base + "/events?" + buildParams().toString();
        if (viewMode === "summary3h") {
          url = base + "/events/summary/3h?limit=" + encodeURIComponent(limitInput.value || 200);
        } else if (viewMode === "summaryDay") {
          url = base + "/events/summary/day?limit=" + encodeURIComponent(limitInput.value || 200);
        }

        const headers = {};
        const apiKey = apiKeyInput.value.trim();
        if (apiKey) headers["X-API-Key"] = apiKey;

        const res = await fetch(url, { headers });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        const items = data.items || [];
        latestPayload = items;

        renderView(items);
        renderStats(items);
        countLabel.textContent = `${items.length} event(s)`;
        serverLabel.textContent = base;
        statusDot.className = "status-dot";
      } catch (e) {
        feedback.textContent = "API error: " + e.message;
        tableBody.innerHTML = '<tr><td colspan="4" class="muted">No data</td></tr>';
        statusDot.className = "status-dot err";
        serverLabel.textContent = "Error";
      }
    }

    function renderView(items) {
      const filtered = filterQuick(items);
      if (viewMode === "table") {
        setTableHeader(["Timestamp", "Source/Login", "Text", "Score/Value"]);
        renderTable(filtered);
      } else if (viewMode === "summary3h") {
        setTableHeader(["Period/Timestamp", "Type", "Text", "Hash", "Score/Value"]);
        renderSummary3h(filtered);
      } else if (viewMode === "summaryDay") {
        setTableHeader(["Date/Timestamp", "Type", "Text", "Hash", "Score/Value"]);
        renderSummaryDay(filtered);
      }
    }

    function filterQuick(items) {
      const q = searchInput.value.trim().toLowerCase();
      if (!q) return items;
      return items.filter(ev => {
        const str = [
          ev.source, ev.login, ev.text, ev.description, ev.msg, ev.timestamp
        ].filter(Boolean).join(" ").toLowerCase();
        return str.includes(q);
      });
    }

    function filterByHours(items, hours) {
      const now = Date.now();
      const cutoff = now - hours * 3600 * 1000;
      return items.filter(ev => {
        const ts = new Date(ev.timestamp || ev.ts).getTime();
        return !isNaN(ts) && ts >= cutoff;
      });
    }

    function setTableHeader(cols) {
      tableHead.innerHTML = cols.map(c => `<th>${c}</th>`).join("");
    }

    function renderTable(items) {
      if (!items.length) {
        tableBody.innerHTML = '<tr><td colspan="4" class="muted">No events with the current filters.</td></tr>';
        return;
      }

      tableBody.innerHTML = items.map(ev => {
        const ts = formatDate(ev.timestamp || ev.ts);
        const src = ev.source || ev.login || "—";
        const text = ev.text || ev.texto || ev.description || ev.msg || "—";
        const score = ev.score ?? ev.value ?? "—";
        const numericScore = typeof score === "number" ? score : null;
        const tagClass = numericScore !== null && numericScore >= 0.6 ? "tag warn" : "tag";
        const scoreText = numericScore !== null ? numericScore.toFixed(2) : score;

        return `
          <tr>
            <td>${ts}</td>
            <td><span class="tag ${tagClass.includes("warn") ? "warn" : ""}"><span class="status-dot ${tagClass.includes("warn") ? "warn" : ""}"></span>${escapeHtml(src)}</span></td>
            <td>${escapeHtml(text)}</td>
            <td>${scoreText}</td>
          </tr>
        `;
      }).join("");
    }

    function renderSummary3h(items) {
      if (!items.length) {
        tableBody.innerHTML = '<tr><td colspan="5" class="muted">No events with the current filters.</td></tr>';
        return;
      }

      const rows = items.map(ev => {
        const period = ev.period || ev.timestamp || ev.date || "—";
        const tipo = ev.tipo || ev.type || "—";
        const texto = ev.text || ev.texto || ev.descripcion || ev.msg || ev.summary || "—";
        const hash = ev.events_hash || ev.hash || "—";
        const score = ev.score ?? ev.value ?? ev.valor ?? ev.promedio ?? "—";
        const scoreText = typeof score === "number" ? score.toFixed(2) : score;
        return `
          <tr>
            <td>${escapeHtml(period)}</td>
            <td>${escapeHtml(tipo)}</td>
            <td>${escapeHtml(texto)}</td>
            <td>${escapeHtml(hash)}</td>
            <td>${escapeHtml(scoreText)}</td>
          </tr>
        `;
      }).join("");

      tableBody.innerHTML = rows || '<tr><td colspan="5" class="muted">No data</td></tr>';
    }

    function renderSummaryDay(items) {
      if (!items.length) {
        tableBody.innerHTML = '<tr><td colspan="5" class="muted">No events with the current filters.</td></tr>';
        return;
      }

      const rows = items.map(ev => {
        const fecha = ev.date || (ev.timestamp ? (ev.timestamp.slice(0,10)) : "—");
        const tipo = ev.tipo || ev.type || "—";
        const texto = ev.text || ev.texto || ev.descripcion || ev.msg || ev.summary || "—";
        const hash = ev.events_hash || ev.hash || "—";
        const score = ev.score ?? ev.value ?? ev.valor ?? ev.promedio ?? "—";
        const scoreText = typeof score === "number" ? score.toFixed(2) : score;
        return `
          <tr>
            <td>${escapeHtml(fecha)}</td>
            <td>${escapeHtml(tipo)}</td>
            <td>${escapeHtml(texto)}</td>
            <td>${escapeHtml(hash)}</td>
            <td>${escapeHtml(scoreText)}</td>
          </tr>
        `;
      }).join("");

      tableBody.innerHTML = rows || '<tr><td colspan="5" class="muted">No data</td></tr>';
    }

    function renderStats(items) {
      if (!items.length) {
        avgScore.textContent = "—";
        timeRange.textContent = "No data";
        scoreDetail.textContent = "Uses score/value when present";
        return;
      }

      const scores = items
        .map(i => (typeof i.score === "number" ? i.score : (typeof i.value === "number" ? i.value : null)))
        .filter(v => v !== null);
      const avg = scores.length ? (scores.reduce((a,b)=>a+b,0) / scores.length) : null;
      avgScore.textContent = avg !== null ? avg.toFixed(2) : "s/d";
      scoreDetail.textContent = `${scores.length} events with score/value`;

      const last = items[0];
      const firstTs = formatDate(items[items.length - 1].timestamp || items[items.length - 1].ts);
      const lastTs = formatDate(last.timestamp || last.ts);
      timeRange.textContent = `From ${firstTs} to ${lastTs}`;
    }

    function formatDate(value) {
      if (!value) return "—";
      const d = new Date(value);
      if (isNaN(d.getTime())) return value;
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function notify(msg, isError) {
      feedback.textContent = msg;
      feedback.style.color = isError ? "#fca5a5" : "#22c55e";
      setTimeout(() => {
        feedback.textContent = "";
        feedback.style.color = "#fca5a5";
      }, 2200);
    }

    window.addEventListener("error", (e) => {
      feedback.textContent = "Error JS: " + e.message;
      feedback.style.color = "#fca5a5";
    });

    loadEvents();
  </script>
</body>
</html>
