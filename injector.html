<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Event Injector - OmniStatus</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
      margin: 0; 
      padding: 24px; 
      line-height: 1.6; 
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      min-height: 100vh;
      color: #333;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: rgba(255, 255, 255, 0.95); 
      border-radius: 16px; 
      padding: 32px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    h2 { 
      margin: 0 0 32px 0; 
      font-size: 2.5rem; 
      font-weight: 700; 
      background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      text-align: center;
    }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    label { 
      display: block; 
      font-weight: 600; 
      margin: 16px 0 8px 0; 
      color: #374151; 
      font-size: 14px;
    }
    input, textarea, select { 
      width: 100%; 
      padding: 12px 16px; 
      font-size: 14px; 
      border: 2px solid #e5e7eb; 
      border-radius: 8px; 
      transition: all 0.2s ease;
      background: #fff;
    }
    input:focus, textarea:focus, select:focus { 
      outline: none; 
      border-color: #3b82f6; 
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
    }
    button { 
      padding: 12px 20px; 
      font-size: 14px; 
      font-weight: 600; 
      cursor: pointer; 
      border: none; 
      border-radius: 8px; 
      transition: all 0.2s ease;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      margin: 4px;
    }
    button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3); 
    }
    button:active { transform: translateY(0); }
    .muted { 
      color: #6b7280; 
      font-size: 12px; 
      margin-top: 8px; 
      line-height: 1.4;
    }
    .log { 
      background: #1a1a1a; 
      color: #e6edf3; 
      padding: 20px; 
      border-radius: 12px; 
      white-space: pre-wrap; 
      max-height: 400px; 
      overflow-y: auto; 
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      border: 1px solid #333;
    }
    .ok { color: #22c55e; }
    .err { color: #ef4444; }
    .card { 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      padding: 24px; 
      margin-bottom: 24px; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s ease;
    }
    .card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .card h3 { 
      margin: 0 0 20px 0; 
      font-size: 1.25rem; 
      font-weight: 600; 
      color: #374151;
    }
    .button-group { 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
      margin-top: 16px; 
    }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-online { background: #22c55e; }
    .status-offline { background: #ef4444; }
    .grid-2 { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 16px; 
    }
    @media (max-width: 768px) {
      .container { margin: 16px; padding: 20px; }
      .grid-2 { grid-template-columns: 1fr; }
      h2 { font-size: 2rem; }
    }
  </style>
  <script>
    async function postEvent(baseUrl, payload, apiKey) {
      const url = baseUrl.replace(/\/$/, '') + '/event';
      const headers = { 'Content-Type': 'application/json' };
      if (apiKey) headers['X-API-Key'] = apiKey;
      const res = await fetch(url, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload),
      });
      const text = await res.text();
      let body = text;
      try { body = JSON.parse(text); } catch {}
      return { status: res.status, ok: res.ok, body };
    }

    function nowIso() {
      return new Date().toISOString().replace(/\.\d{3}Z$/, 'Z');
    }

    function randBetween(min, max) {
      return Math.random() * (max - min) + min;
    }

    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function genRandomEvent() {
      const sources = ['cam_entrance', 'cam_yards', 'cam_warehouse', 'cam_parking'];
      const descriptions = [
        'Person detected near the door',
        'Vehicle approaching restricted zone',
        'Unusual movement in warehouse',
        'Possible suspicious object',
      ];
      return {
        source: pick(sources),
        description: pick(descriptions),
        value: Math.round(randBetween(0.1, 0.99) * 100) / 100,
        timestamp: nowIso(),
      };
    }

    function readFormEvent() {
      const source = document.getElementById('source').value.trim();
      const description = document.getElementById('description').value.trim();
      const valueStr = document.getElementById('value').value.trim();
      const ts = document.getElementById('timestamp').value.trim();
      const value = valueStr === '' ? null : Number(valueStr);
      const payload = { source, description };
      if (!source || !description) throw new Error('source and description are required');
      if (!Number.isNaN(value) && value !== null) payload.value = value;
      if (ts) payload.timestamp = ts;
      return payload;
    }

    let successCount = 0;
    let errorCount = 0;

    function log(line, type) {
      const el = document.getElementById('log');
      const span = document.createElement('div');
      if (type === 'ok') {
        span.className = 'ok';
        successCount++;
      }
      if (type === 'err') {
        span.className = 'err';
        errorCount++;
      }
      span.textContent = line;
      el.prepend(span);
      
      // Show success message if there are successful events and no errors
      const successMsg = document.getElementById('successMessage');
      if (successCount > 0 && errorCount === 0) {
        successMsg.style.display = 'block';
        successMsg.innerHTML = `‚úÖ ${successCount} event(s) injected successfully!`;
      } else if (errorCount > 0) {
        successMsg.style.display = 'none';
      }
    }

    async function sendOne(ev) {
      const baseUrl = document.getElementById('baseUrl').value.trim() || 'http://localhost:8001';
      const apiKey = document.getElementById('apiKey').value.trim();
      try {
        const payload = ev === 'random' ? genRandomEvent() : readFormEvent();
        const { ok, status, body } = await postEvent(baseUrl, payload, apiKey);
        if (ok) log(`‚úî (${status}) ${JSON.stringify(payload)} => ${JSON.stringify(body)}`, 'ok');
        else log(`‚úñ (${status}) ${JSON.stringify(payload)} => ${typeof body === 'string' ? body : JSON.stringify(body)}`, 'err');
      } catch (e) {
        log(`‚úñ Error: ${e}`, 'err');
      }
    }

    async function sendBurst() {
      const baseUrl = document.getElementById('baseUrl').value.trim() || 'http://localhost:8001';
      const apiKey = document.getElementById('apiKey').value.trim();
      const count = Number(document.getElementById('burstCount').value) || 5;
      for (let i = 0; i < count; i++) {
        const payload = genRandomEvent();
        try {
          const { ok, status, body } = await postEvent(baseUrl, payload, apiKey);
          if (ok) log(`‚úî (${status}) ${JSON.stringify(payload)} => ${JSON.stringify(body)}`, 'ok');
          else log(`‚úñ (${status}) ${JSON.stringify(payload)} => ${typeof body === 'string' ? body : JSON.stringify(body)}`, 'err');
        } catch (e) {
          log(`‚úñ Error: ${e}`, 'err');
        }
        await new Promise(r => setTimeout(r, 150));
      }
    }

    async function checkServerStatus() {
      const baseUrl = document.getElementById('baseUrl').value.trim() || 'http://localhost:8001';
      const apiKey = document.getElementById('apiKey').value.trim();
      const statusEl = document.getElementById('serverStatus');
      const indicator = statusEl.querySelector('.status-indicator');
      const text = statusEl.querySelector('span:last-child');
      
      try {
        const url = baseUrl.replace(/\/$/, '') + '/health';
        const headers = apiKey ? { 'X-API-Key': apiKey } : {};
        const res = await fetch(url, { method: 'GET', headers, timeout: 5000 });
        if (res.ok) {
          indicator.className = 'status-indicator status-online';
          text.textContent = 'Connected';
          log(`üîç Server verified: ${baseUrl}`, 'ok');
        } else {
          indicator.className = 'status-indicator status-offline';
          text.textContent = `Error ${res.status}`;
          log(`üîç Server responded with error: ${res.status}`, 'err');
        }
      } catch (e) {
        indicator.className = 'status-indicator status-offline';
        text.textContent = 'Disconnected';
        log(`üîç Error verifying server: ${e.message}`, 'err');
      }
    }

    async function reviewAllLogs() {
      const baseUrl = document.getElementById('baseUrl').value.trim() || 'http://localhost:8001';
      const apiKey = document.getElementById('apiKey').value.trim();
      try {
        const url = baseUrl.replace(/\/$/, '') + '/events';
        const headers = apiKey ? { 'X-API-Key': apiKey } : {};
        const res = await fetch(url, { method: 'GET', headers });
        if (res.ok) {
          const data = await res.json();
          const events = data.items || [];
          log(`üìä Log review: ${events.length} events found`, 'ok');

          if (events.length > 0) {
            // Show last 10 events
            const recentEvents = events.slice(-10);
            recentEvents.forEach((event, index) => {
              const timestamp = event.timestamp || 'No timestamp';
              const source = event.source || 'No source';
              const description = event.description || 'No description';
              const value = event.value !== undefined ? event.value : 'N/A';
              log(`  ${events.length - 10 + index + 1}. [${timestamp}] ${source}: ${description} (value=${value})`, 'ok');
            });

            if (events.length > 10) {
              log(`  ... and ${events.length - 10} more events`, 'ok');
            }
          } else {
            log('  No events in log', 'ok');
          }
        } else {
          log(`‚úñ Error getting logs: ${res.status}`, 'err');
        }
      } catch (e) {
        log(`‚úñ Error reviewing logs: ${e.message}`, 'err');
      }
    }

    function clearLog() {
      document.getElementById('log').innerHTML = 'Log cleared...';
      document.getElementById('successMessage').style.display = 'none';
      successCount = 0;
      errorCount = 0;
    }

    // Check server status on page load
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(checkServerStatus, 1000);
    });
  </script>
</head>
<body>
  <div class="container">
    <h2>üöÄ OmniStatus Event Injector</h2>

    <div class="card">
      <h3>üîó Server Configuration</h3>
      <label>Server URL</label>
      <input id="baseUrl" placeholder="http://localhost:8001" value="http://localhost:8001">
      <label>API Key (X-API-Key)</label>
      <input id="apiKey" placeholder="optional">
      <div class="muted">The endpoint used is <code>/event</code>. Make sure the server is running and CORS is enabled.</div>
    </div>

    <div class="card">
      <h3>üìù Send Manual Event</h3>
      <label>Source</label>
      <input id="source" placeholder="cam_entrance">
      <label>Description</label>
      <input id="description" placeholder="Person detected">
      <div class="grid-2">
        <div>
          <label>Value (optional)</label>
          <input id="value" type="number" step="0.01" placeholder="0.85">
        </div>
        <div>
          <label>Timestamp (ISO8601 - optional)</label>
          <input id="timestamp" placeholder="2025-10-01T12:00:00Z">
        </div>
      </div>
      <div class="button-group">
        <button onclick="sendOne('manual')">üì§ Send</button>
        <button onclick="(document.getElementById('timestamp').value = new Date().toISOString().replace(/\.\d{3}Z$/, 'Z'))">‚è∞ Now</button>
        <button onclick="document.getElementById('source').value='cam_entrance'; document.getElementById('description').value='Person detected'; document.getElementById('value').value='0.9';">üéØ Example</button>
      </div>
    </div>

    <div class="card">
      <h3>üé≤ Send Random Events</h3>
      <div class="grid-2">
        <div>
          <label>Number of events</label>
          <input id="burstCount" type="number" value="1" min="1" max="100">
        </div>
        <div>
          <label>Server status</label>
          <div id="serverStatus" style="display: flex; align-items: center; margin-top: 8px;">
            <span class="status-indicator status-offline"></span>
            <span>Unknown</span>
          </div>
        </div>
      </div>
      <div class="button-group">
        <button onclick="sendOne('random')">üé≤ Send 1 Random</button>
        <button onclick="sendBurst()">üöÄ Send Burst</button>
        <button onclick="checkServerStatus()">üîç Check Server</button>
      </div>
    </div>

    <div class="card">
      <h3>üìã Activity Log</h3>
      <div id="successMessage" style="display: none; background: #dcfce7; color: #166534; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #22c55e;">
        ‚úÖ Events injected successfully!
      </div>
      <div id="log" class="log">Waiting for events...</div>
      <div class="button-group">
        <button onclick="reviewAllLogs()">üìä Review All Logs</button>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
      </div>
    </div>
  </div>
</body>
</html>
